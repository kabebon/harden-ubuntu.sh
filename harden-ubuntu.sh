#!/bin/bash
# =============================================================================
# harden-ubuntu.sh ‚Äî —É–ª—å—Ç–∏–º–∞—Ç–∏–≤–Ω–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ Ubuntu-—Å–µ—Ä–≤–µ—Ä–∞ v4.0
# =============================================================================
# –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:
#   - –ù–µ —Ä–∞–∑—Ä—ã–≤–∞–µ—Ç —Ç–µ–∫—É—â—É—é —Å–µ—Å—Å–∏—é (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç kill -HUP)
#   - –Ø—Ä–∫–æ–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏ –∫–ª—é—á–∞
#   - –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å socket activation
#   - –ü–æ–ª–Ω—ã–π –æ—Ç–∫–∞—Ç –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
# =============================================================================

set -euo pipefail

# –¶–≤–µ—Ç–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# –ü—Ä–æ–≤–µ—Ä–∫–∞ root
if [[ $EUID -ne 0 ]]; then
    echo -e "${RED}–ó–∞–ø—É—Å—Ç–∏—Ç–µ –æ—Ç root${NC}"
    exit 1
fi

# –ó–∞—â–∏—Ç–∞ –æ—Ç curl | bash
if ! test -t 0; then
    echo -e "${RED}–ù–µ –∑–∞–ø—É—Å–∫–∞–π—Ç–µ —á–µ—Ä–µ–∑ curl | bash ‚Äî —Å–∫–∞—á–∞–π—Ç–µ –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ –æ—Ç–¥–µ–ª—å–Ω–æ${NC}"
    exit 1
fi

# -----------------------------------------------------------------------------
# –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
# -----------------------------------------------------------------------------
ROLLBACK_LOG="/root/harden-rollback-$(date +%Y%m%d-%H%M%S).log"
SSHD_BACKUP=""
USER_CREATED=false
SUDOERS_FILE=""
KEY_DIR=""
OLD_PORT=$(ss -tulpn | grep sshd | head -1 | grep -oP ':\K\d+' || echo "22")

echo "–õ–æ–≥ –æ—Ç–∫–∞—Ç–∞: $ROLLBACK_LOG" | tee "$ROLLBACK_LOG"
echo "–¢–µ–∫—É—â–∏–π –ø–æ—Ä—Ç SSH: $OLD_PORT" | tee -a "$ROLLBACK_LOG"

# -----------------------------------------------------------------------------
# –§—É–Ω–∫—Ü–∏—è –æ—Ç–∫–∞—Ç–∞
# -----------------------------------------------------------------------------
rollback() {
    echo -e "\n${RED}–û—Ç–∫–∞—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π...${NC}" | tee -a "$ROLLBACK_LOG"

    # –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ sshd_config
    if [ -n "$SSHD_BACKUP" ] && [ -f "$SSHD_BACKUP" ]; then
        cp "$SSHD_BACKUP" /etc/ssh/sshd_config
        echo "‚Üí sshd_config –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω" | tee -a "$ROLLBACK_LOG"
        # –ü–æ—Å—ã–ª–∞–µ–º HUP, —á—Ç–æ–±—ã –ø—Ä–∏–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ä—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
        pkill -HUP sshd 2>/dev/null || true
    fi

    # –£–¥–∞–ª–µ–Ω–∏–µ override –¥–ª—è socket (–µ—Å–ª–∏ —Å–æ–∑–¥–∞–≤–∞–ª–∏)
    rm -rf /etc/systemd/system/ssh.socket.d 2>/dev/null
    systemctl daemon-reload
    systemctl try-reload-or-restart ssh.socket 2>/dev/null || true

    # –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–µ—Å–ª–∏ —Å–æ–∑–¥–∞–Ω —Å–∫—Ä–∏–ø—Ç–æ–º)
    if $USER_CREATED && id "$NEW_USER" &>/dev/null; then
        deluser --remove-home "$NEW_USER" 2>/dev/null
        rm -f "$SUDOERS_FILE" 2>/dev/null
        echo "‚Üí –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å $NEW_USER —É–¥–∞–ª—ë–Ω" | tee -a "$ROLLBACK_LOG"
    fi

    # –û—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ–π –ø–∞–ø–∫–∏
    rm -rf "$KEY_DIR" 2>/dev/null

    echo -e "${YELLOW}–û—Ç–∫–∞—Ç –∑–∞–≤–µ—Ä—à—ë–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–∏—Å—Ç–µ–º—É!${NC}" | tee -a "$ROLLBACK_LOG"
    exit 1
}
trap rollback INT TERM

# -----------------------------------------------------------------------------
# –í–≤–æ–¥ –¥–∞–Ω–Ω—ã—Ö
# -----------------------------------------------------------------------------
echo -e "\n${YELLOW}–ò–º—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Ç–æ–ª—å–∫–æ a-z, 0-9, _, -, –æ—Ç 3 –¥–æ 32 —Å–∏–º–≤–æ–ª–æ–≤):${NC}"
read -r -p "> " NEW_USER
NEW_USER=${NEW_USER:-admin}
if [[ ! "$NEW_USER" =~ ^[a-zA-Z0-9_-]{3,32}$ ]]; then
    echo -e "${RED}–ù–µ–¥–æ–ø—É—Å—Ç–∏–º–æ–µ –∏–º—è${NC}"
    exit 1
fi

if id "$NEW_USER" &>/dev/null; then
    echo -e "${YELLOW}–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å $NEW_USER —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç. –ö–ª—é—á –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω.${NC}"
    read -r -p "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å? [y/N]: " cont
    [[ "$cont" =~ ^[Yy]$ ]] || exit 0
    USER_EXISTS=true
else
    USER_EXISTS=false
fi

# –ó–∞–ø—Ä–æ—Å –ø–æ—Ä—Ç–∞
echo -e "\n${YELLOW}–ù–æ–≤—ã–π –ø–æ—Ä—Ç SSH (1024-65535):${NC}"
read -r -p "> " NEW_PORT
NEW_PORT=${NEW_PORT:-2222}
if ! [[ "$NEW_PORT" =~ ^[0-9]+$ ]] || [ "$NEW_PORT" -lt 1024 ] || [ "$NEW_PORT" -gt 65535 ]; then
    echo -e "${RED}–ù–µ–≤–µ—Ä–Ω—ã–π –ø–æ—Ä—Ç (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 1024 –¥–æ 65535)${NC}"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞, –Ω–µ –∑–∞–Ω—è—Ç –ª–∏ –ø–æ—Ä—Ç
if ss -tuln | grep -q ":$NEW_PORT "; then
    echo -e "${RED}–ü–æ—Ä—Ç $NEW_PORT —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥—Ä—É–≥–∏–º –ø—Ä–æ—Ü–µ—Å—Å–æ–º.${NC}"
    exit 1
fi

# -----------------------------------------------------------------------------
# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª—é—á–µ–π
# -----------------------------------------------------------------------------
echo -e "\n${GREEN}–ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø–∞—Ä—É ed25519 –∫–ª—é—á–µ–π...${NC}\n"

KEY_DIR="/root/temp-ssh-key-$(date +%s)"
mkdir -p "$KEY_DIR" && chmod 700 "$KEY_DIR"

# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª—é—á–∞ (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö)
ssh-keygen -t ed25519 -f "$KEY_DIR/id_ed25519" -N "" -C "${NEW_USER}@$(hostname)-$(date +%Y%m%d)" >/dev/null 2>&1

PUB_KEY=$(cat "$KEY_DIR/id_ed25519.pub")
PRIV_KEY=$(cat "$KEY_DIR/id_ed25519")

# –í—ã–≤–æ–¥ –∫–ª—é—á–µ–π
echo -e "${YELLOW}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
echo -e "${YELLOW}                  –ü–†–ò–í–ê–¢–ù–´–ô –ö–õ–Æ–ß (–°–ö–û–ü–ò–†–£–ô–¢–ï –°–ï–ô–ß–ê–°)             ${NC}"
echo -e "${YELLOW}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}\n"
echo "$PRIV_KEY"
echo -e "\n${YELLOW}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}\n"
echo -e "${GREEN}–ü—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á (–±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω):${NC}\n$PUB_KEY\n"

# -----------------------------------------------------------------------------
# –ö–†–ê–°–ù–û–ï –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï (–ø–µ—Ä–µ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º)
# -----------------------------------------------------------------------------
echo -e "${RED}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
echo -e "${RED}‚ïë                     –í–ù–ò–ú–ê–ù–ò–ï!                                   ‚ïë${NC}"
echo -e "${RED}‚ïë  –í—ã –î–û–õ–ñ–ù–´ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ü–†–ò–í–ê–¢–ù–´–ô –ö–õ–Æ–ß (—Ç–æ—Ç, —á—Ç–æ –≤—ã—à–µ)            ‚ïë${NC}"
echo -e "${RED}‚ïë  –≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ –º–µ—Å—Ç–æ –Ω–∞ —Å–≤–æ—ë–º –∫–æ–º–ø—å—é—Ç–µ—Ä–µ.                        ‚ïë${NC}"
echo -e "${RED}‚ïë  –ü–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∫–ª—é—á –±—É–¥–µ—Ç –£–î–ê–õ–Å–ù –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å           ‚ïë${NC}"
echo -e "${RED}‚ïë  –¥–æ—Å—Ç—É–ø –±—É–¥–µ—Ç –ù–ï–í–û–ó–ú–û–ñ–ù–û!                                        ‚ïë${NC}"
echo -e "${RED}‚ïë                                                                   ‚ïë${NC}"
echo -e "${RED}‚ïë  –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã:                                              ‚ïë${NC}"
echo -e "${RED}‚ïë  1. –í—ã–¥–µ–ª–∏–ª–∏ –∏ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–ª–∏ –í–ï–°–¨ –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á (–æ—Ç BEGIN –¥–æ END) ‚ïë${NC}"
echo -e "${RED}‚ïë  2. –°–æ—Ö—Ä–∞–Ω–∏–ª–∏ –µ–≥–æ –≤ —Ñ–∞–π–ª (–Ω–∞–ø—Ä–∏–º–µ—Ä, ~/.ssh/id_ed25519)           ‚ïë${NC}"
echo -e "${RED}‚ïë  3. –£—Å—Ç–∞–Ω–æ–≤–∏–ª–∏ –ø—Ä–∞–≤–∞ 600 –Ω–∞ —Ñ–∞–π–ª —Å –∫–ª—é—á–æ–º                        ‚ïë${NC}"
echo -e "${RED}‚ïë  4. –ú–æ–∂–µ—Ç–µ –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –ø–æ —ç—Ç–æ–º—É –∫–ª—é—á—É                            ‚ïë${NC}"
echo -e "${RED}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}\n"

read -r -p "–í–≤–µ–¥–∏—Ç–µ yes –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è: " confirm
if [[ "$confirm" != "yes" ]]; then
    echo -e "${RED}–ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ. –í—ã—Ö–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π.${NC}"
    rm -rf "$KEY_DIR"
    exit 1
fi

# -----------------------------------------------------------------------------
# –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π (–ë–ï–ó –ü–ï–†–ï–ó–ê–ü–£–°–ö–ê SSH)
# -----------------------------------------------------------------------------

# 1. –ë—ç–∫–∞–ø sshd_config
SSHD_BACKUP="/etc/ssh/sshd_config.bak.$(date +%Y%m%d-%H%M%S)"
cp /etc/ssh/sshd_config "$SSHD_BACKUP"
echo "‚Üí –ë—ç–∫–∞–ø —Å–æ–∑–¥–∞–Ω: $SSHD_BACKUP" | tee -a "$ROLLBACK_LOG"

# 2. –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–ª)
if ! $USER_EXISTS; then
    adduser --disabled-password --gecos "" "$NEW_USER"
    usermod -aG sudo "$NEW_USER"
    SUDOERS_FILE="/etc/sudoers.d/90-$NEW_USER"
    echo "$NEW_USER ALL=(ALL) NOPASSWD:ALL" > "$SUDOERS_FILE"
    chmod 0440 "$SUDOERS_FILE"
    USER_CREATED=true
    echo "‚Üí –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å $NEW_USER —Å–æ–∑–¥–∞–Ω –∏ –¥–æ–±–∞–≤–ª–µ–Ω –≤ sudo" | tee -a "$ROLLBACK_LOG"
fi

# 3. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–ª—é—á–∞
mkdir -p "/home/$NEW_USER/.ssh"
echo "$PUB_KEY" > "/home/$NEW_USER/.ssh/authorized_keys"
chown -R "$NEW_USER:$NEW_USER" "/home/$NEW_USER/.ssh"
chmod 700 "/home/$NEW_USER/.ssh"
chmod 600 "/home/$NEW_USER/.ssh/authorized_keys"
echo "‚Üí –ü—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á –¥–æ–±–∞–≤–ª–µ–Ω" | tee -a "$ROLLBACK_LOG"

# 4. –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ sshd_config (–¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –ø–æ—Ä—Ç, –Ω–æ –æ—Å—Ç–∞–≤–ª—è–µ–º —Å—Ç–∞—Ä—ã–π)
if grep -q "^Port" /etc/ssh/sshd_config; then
    # –ï—Å–ª–∏ –µ—Å—Ç—å —Å—Ç—Ä–æ–∫–∏ Port, –∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–µ–º –∏—Ö
    sed -i 's/^Port/#Port/g' /etc/ssh/sshd_config
fi
# –î–æ–±–∞–≤–ª—è–µ–º –æ–±–∞ –ø–æ—Ä—Ç–∞
{
    echo "Port $OLD_PORT"
    echo "Port $NEW_PORT"
} >> /etc/ssh/sshd_config

# –û—Ç–∫–ª—é—á–∞–µ–º root –∏ –ø–∞—Ä–æ–ª–∏
sed -i 's/^#*PermitRootLogin.*/PermitRootLogin no/' /etc/ssh/sshd_config
sed -i 's/^#*PasswordAuthentication.*/PasswordAuthentication no/' /etc/ssh/sshd_config

# –î–æ–±–∞–≤–ª—è–µ–º ListenAddress –¥–ª—è –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç–∏
if ! grep -q "^ListenAddress" /etc/ssh/sshd_config; then
    echo "ListenAddress 0.0.0.0" >> /etc/ssh/sshd_config
    echo "ListenAddress ::" >> /etc/ssh/sshd_config
else
    # –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ —Å–ª—É—à–∞–µ—Ç –Ω–∞ –≤—Å–µ—Ö –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞—Ö
    sed -i 's/^#*ListenAddress.*/ListenAddress 0.0.0.0\nListenAddress ::/' /etc/ssh/sshd_config
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞
if ! sshd -t; then
    echo -e "${RED}–û—à–∏–±–∫–∞ –≤ sshd_config. –û—Ç–∫–∞—Ç...${NC}" | tee -a "$ROLLBACK_LOG"
    rollback
fi
echo "‚Üí sshd_config –æ–±–Ω–æ–≤–ª—ë–Ω, —Å–∏–Ω—Ç–∞–∫—Å–∏—Å –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω" | tee -a "$ROLLBACK_LOG"

# 5. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ SSH –±–µ–∑ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ (–ø–æ—Å—ã–ª–∞–µ–º —Å–∏–≥–Ω–∞–ª HUP)
# –ù–∞—Ö–æ–¥–∏–º PID –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ sshd
SSHD_PID=$(pgrep -f "sshd:.*listener" | head -1)
if [ -n "$SSHD_PID" ]; then
    kill -HUP "$SSHD_PID"
    echo "‚Üí –°–∏–≥–Ω–∞–ª HUP –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω sshd (pid $SSHD_PID). –ù–æ–≤—ã–π –ø–æ—Ä—Ç $NEW_PORT –±—É–¥–µ—Ç –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –±–µ–∑ —Ä–∞–∑—Ä—ã–≤–∞ —Å–µ—Å—Å–∏–π." | tee -a "$ROLLBACK_LOG"
    sleep 2
else
    # –ï—Å–ª–∏ sshd –Ω–µ –∑–∞–ø—É—â–µ–Ω (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–∏ socket activation), –∑–∞–ø—É—Å—Ç–∏–º –µ–≥–æ —á–µ—Ä–µ–∑ socket
    echo "‚Üí sshd –Ω–µ –∑–∞–ø—É—â–µ–Ω, –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º —á–µ—Ä–µ–∑ socket..." | tee -a "$ROLLBACK_LOG"
    systemctl try-reload-or-restart ssh.socket
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –Ω–æ–≤—ã–π –ø–æ—Ä—Ç –Ω–∞—á–∞–ª —Å–ª—É—à–∞—Ç—å—Å—è (–∂–¥—ë–º –Ω–µ–º–Ω–æ–≥–æ)
sleep 3
if ss -tuln | grep -q ":$NEW_PORT"; then
    echo -e "${GREEN}‚úì –ù–æ–≤—ã–π –ø–æ—Ä—Ç $NEWPORT —É—Å–ø–µ—à–Ω–æ –æ—Ç–∫—Ä—ã—Ç (IPv4/IPv6)${NC}" | tee -a "$ROLLBACK_LOG"
else
    echo -e "${RED}‚úó –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –ø–æ—Ä—Ç $NEW_PORT${NC}" | tee -a "$ROLLBACK_LOG"
    rollback
fi

# -----------------------------------------------------------------------------
# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ UFW
# -----------------------------------------------------------------------------
if ! command -v ufw &>/dev/null; then
    apt update -qq && apt install -y ufw
fi

ufw allow "$NEW_PORT"/tcp
ufw allow 80/tcp 2>/dev/null || true
ufw allow 443/tcp 2>/dev/null || true

if ! ufw status | grep -q "Status: active"; then
    echo "y" | ufw enable
fi

# -----------------------------------------------------------------------------
# BBR
# -----------------------------------------------------------------------------
if sysctl net.ipv4.tcp_available_congestion_control | grep -q bbr; then
    if ! sysctl net.ipv4.tcp_congestion_control | grep -q bbr; then
        echo "net.core.default_qdisc=fq" >> /etc/sysctl.conf
        echo "net.ipv4.tcp_congestion_control=bbr" >> /etc/sysctl.conf
        sysctl -p
        echo "‚Üí BBR –≤–∫–ª—é—á—ë–Ω" | tee -a "$ROLLBACK_LOG"
    else
        echo "‚Üí BBR —É–∂–µ –∞–∫—Ç–∏–≤–µ–Ω" | tee -a "$ROLLBACK_LOG"
    fi
else
    echo "‚Üí BBR –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –≤ —è–¥—Ä–µ" | tee -a "$ROLLBACK_LOG"
fi

# -----------------------------------------------------------------------------
# fail2ban
# -----------------------------------------------------------------------------
apt update -qq && apt install -y fail2ban
cat > /etc/fail2ban/jail.local <<EOT
[sshd]
enabled   = true
port      = $NEW_PORT
logpath   = %(sshd_log)s
maxretry  = 5
bantime   = 3600
findtime  = 600
EOT
systemctl restart fail2ban
echo "‚Üí fail2ban –Ω–∞—Å—Ç—Ä–æ–µ–Ω" | tee -a "$ROLLBACK_LOG"

# -----------------------------------------------------------------------------
# –§–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
# -----------------------------------------------------------------------------
SERVER_IP=$(hostname -I | awk '{print $1}')

echo -e "\n${GREEN}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
echo -e "               üéâ –ù–ê–°–¢–†–û–ô–ö–ê –£–°–ü–ï–®–ù–û –ó–ê–í–ï–†–®–ï–ù–ê üéâ"
echo -e "${GREEN}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}\n"
echo -e "${YELLOW}‚úÖ –¢–ï–ö–£–©–ê–Ø SSH-–°–ï–°–°–ò–Ø –ù–ï –ü–†–ï–†–´–í–ê–õ–ê–°–¨!${NC}"
echo -e "${YELLOW}‚úÖ –°–¢–ê–†–´–ô –ü–û–†–¢ $OLD_PORT –í–°–Å –ï–©–Å –†–ê–ë–û–¢–ê–ï–¢!${NC}"
echo -e "${GREEN}‚úÖ –ù–û–í–´–ô –ü–û–†–¢ $NEW_PORT –î–û–ë–ê–í–õ–ï–ù!${NC}\n"
echo -e "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${YELLOW}$NEW_USER${NC}"
echo -e "–ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤ –ù–û–í–û–ú –æ–∫–Ω–µ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞:"
echo -e "  ${YELLOW}ssh -p $NEW_PORT $NEW_USER@$SERVER_IP${NC}\n"
echo -e "${RED}‚ö†Ô∏è  –í–ê–ñ–ù–û:${NC}"
echo "1. –û–¢–ö–†–û–ô–¢–ï –ù–û–í–û–ï –û–ö–ù–û –¢–ï–†–ú–ò–ù–ê–õ–ê (–Ω–µ –∑–∞–∫—Ä—ã–≤–∞—è —ç—Ç–æ!)"
echo "2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø–æ –Ω–æ–≤–æ–π –∫–æ–º–∞–Ω–¥–µ –≤—ã—à–µ"
echo "3. –ï—Å–ª–∏ –ø–æ–¥–∫–ª—é—á–∏–ª–∏—Å—å —É—Å–ø–µ—à–Ω–æ ‚Äî –º–æ–∂–µ—Ç–µ –∑–∞–∫—Ä—ã—Ç—å —Å—Ç–∞—Ä—ã–π –ø–æ—Ä—Ç –≤—Ä—É—á–Ω—É—é –∏–ª–∏ –¥–æ–≤–µ—Ä–∏—Ç—å —ç—Ç–æ —Å–∫—Ä–∏–ø—Ç—É –¥–∞–ª–µ–µ"
echo "4. –ï—Å–ª–∏ –Ω–µ –ø–æ–¥–∫–ª—é—á–∏–ª–∏—Å—å ‚Äî –Ω–∞–∂–º–∏—Ç–µ Ctrl+C –¥–ª—è –æ—Ç–∫–∞—Ç–∞"

echo -e "\n${YELLOW}–û–∂–∏–¥–∞–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏... (–Ω–∞–∂–º–∏—Ç–µ Enter, –µ—Å–ª–∏ –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç, Ctrl+C –¥–ª—è –æ—Ç–∫–∞—Ç–∞)${NC}"
read -r

# -----------------------------------------------------------------------------
# –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ —Å—Ç–∞—Ä–æ–≥–æ –ø–æ—Ä—Ç–∞
# -----------------------------------------------------------------------------
echo -e "\n${GREEN}–•–æ—Ç–∏—Ç–µ, —á—Ç–æ–±—ã —Å–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–∫—Ä—ã–ª —Å—Ç–∞—Ä—ã–π –ø–æ—Ä—Ç $OLD_PORT?${NC}"
echo "–≠—Ç–æ –ë–ï–ó–û–ü–ê–°–ù–û, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤—ã –£–ñ–ï –ø–æ–¥–∫–ª—é—á–∏–ª–∏—Å—å –ø–æ –Ω–æ–≤–æ–º—É –ø–æ—Ä—Ç—É –≤ –¥—Ä—É–≥–æ–º –æ–∫–Ω–µ."
read -r -p "–ó–∞–∫—Ä—ã—Ç—å —Å—Ç–∞—Ä—ã–π –ø–æ—Ä—Ç? (y/N): " close_old

if [[ "$close_old" =~ ^[Yy]$ ]]; then
    echo "–ó–∞–∫—Ä—ã–≤–∞–µ–º —Å—Ç–∞—Ä—ã–π –ø–æ—Ä—Ç $OLD_PORT..." | tee -a "$ROLLBACK_LOG"

    # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –ø–æ—Ä—Ç –∏–∑ sshd_config
    sed -i "/Port $OLD_PORT/d" /etc/ssh/sshd_config

    # –ü–æ—Å—ã–ª–∞–µ–º HUP, —á—Ç–æ–±—ã –ø—Ä–∏–º–µ–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è (—É–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–π –ø–æ—Ä—Ç –∏–∑ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è)
    pkill -HUP sshd 2>/dev/null || true

    # –£–¥–∞–ª—è–µ–º –ø—Ä–∞–≤–∏–ª–æ UFW –¥–ª—è —Å—Ç–∞—Ä–æ–≥–æ –ø–æ—Ä—Ç–∞
    ufw delete allow "$OLD_PORT"/tcp 2>/dev/null || true

    echo -e "${GREEN}‚úì –°—Ç–∞—Ä—ã–π –ø–æ—Ä—Ç $OLD_PORT –∑–∞–∫—Ä—ã—Ç${NC}" | tee -a "$ROLLBACK_LOG"
fi

# -----------------------------------------------------------------------------
# –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ
# -----------------------------------------------------------------------------
rm -rf "$KEY_DIR"
echo -e "\n${GREEN}‚úÖ –°–∫—Ä–∏–ø—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à—ë–Ω! –°–µ—Å—Å–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞.${NC}"
trap - INT TERM
exit 0
